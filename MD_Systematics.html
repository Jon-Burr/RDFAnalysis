<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>RDFAnalysis: Including Systematics</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">RDFAnalysis
   &#160;<span id="projectnumber">0.1.1</span>
   </div>
   <div id="projectbrief">Physics analysis with ROOT::RDataFrame</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('MD_Systematics.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Including Systematics </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><ul>
<li><a href="#Systematics_Introduction">Introduction</a></li>
<li><a href="#Systematics_IBranchNamer">The IBranchNamer class</a></li>
<li><a href="#Systematics_UsageExample">Usage Example</a></li>
</ul>
<h1><a class="anchor" id="Systematics_Introduction"></a>
Introduction</h1>
<p>The last remaining piece to add is the impact of systematic variations. A systematic variation is a common way of propagating uncertainties through an analysis. The effect of an uncertainty on a variable is evaluated by shifting its value by some amount (usually 1&sigma;) and propagating the effect of this through the analysis. This then has a domino-like effect as variables and filters that depend on that variable must also be varied, and anything depending on <em>those</em> must be varied too (continuing down through the whole analysis chain).</p>
<p>The easiest way to evaluate this is to run the entire analysis several times, once per systematic variation. However, this is quite wasteful and requires running exactly the same systematic variation multiple times.</p>
<p>The <a class="el" href="classRDFAnalysis_1_1Node.html">Node</a> class has an understanding of systematic variations built into from the start so allows a much more natural approach. Each <a class="el" href="classRDFAnalysis_1_1Node.html">Node</a> contains a std::map from systematic names to ROOT::RDF::RNode objects. These represent all the systematic variations 'active' on that node. These systematic variations are all the ones that affected filters upstream of that node (and therefore may be seeing a different set of events to each other).</p>
<p>When a new operation is applied to a node the following sequence of steps occur</p><ol type="1">
<li>The set of input variables to the operation are determined</li>
<li>The set of systematic variations affecting these inputs is determined</li>
<li>For each active variation on the node the operation is performed</li>
<li>For each remaining systematic variation from step 2, the operation is performed on the nominal variation. For filters this adds more 'active' variations.</li>
</ol>
<p>This behaviour is implemented by the <a class="el" href="classRDFAnalysis_1_1NodeBase.html#a9512cdf43910c1a205d16911fbc3c7f2" title="Transmit a systematically varied action to the underlying ROOT::RNodes. ">RDFAnalysis::NodeBase::Act</a> function (don't worry if you can't read the template syntax for this function, it's unlikely that you will have to interact with it directly).</p>
<p><b>Warning:</b> right now this behaviour doesn't work quite correctly for filter calls using the <a class="el" href="classRDFAnalysis_1_1Node.html#a0af4af2600c553fa2c949b724ca870e3">variant where a decision and weight are calculated simultaneously</a>. This variant is unable to tell which variations affect the decision and which affect the weight, therefore it assumes that each variations affect both of them, resulting in many redundant calculations downstream.</p>
<h1><a class="anchor" id="Systematics_IBranchNamer"></a>
The IBranchNamer class</h1>
<p>All of this is taken care of for you by the <a class="el" href="classRDFAnalysis_1_1IBranchNamer.html">IBranchNamer</a> class. This is an abstract interface that keeps a record of which systematics affect which branches. It is also able to convert between 'base' branch names (which are the ones used in all <a class="el" href="namespaceRDFAnalysis.html">RDFAnalysis</a> classes) and systematic resolved branch names which are used in all underlying ROOT::RDF::RNode calls.</p>
<p>The default version of this class is the <a class="el" href="classRDFAnalysis_1_1DefaultBranchNamer.html" title="Default implementation of the IBranchNamer interface. ">RDFAnalysis::DefaultBranchNamer</a>. This class assumes that all branches in your tree are of the form SystematicName_BranchName (or the same with the order reversed). The class is initialised with a list of systematic names to search for, if no systematic name appears then in a branch name then it is assumed that that branch belongs to the nominal variation.</p>
<h1><a class="anchor" id="Systematics_UsageExample"></a>
Usage Example</h1>
<p>To illustrate this, let's return to the Z&gamma; example. Let's modify the original example to have three systematics: "GAM_KIN" which affects the photon kinematics, "ELE_KIN" which affects the electron kinematics and "MU_KIN" which affects the muon kinematics. The input tree now looks like </p><div class="fragment"><div class="line">std::vector&lt;TLorentzVector&gt; NOSYS_Photons;</div><div class="line">std::vector&lt;TLorentzVector&gt; GAM_KIN_Photons;</div><div class="line">std::vector&lt;TLorentzVector&gt; NOSYS_Electrons;</div><div class="line">std::vector&lt;TLorentzVector&gt; ELE_KIN_Electrons;</div><div class="line">std::vector&lt;TLorentzVector&gt; NOSYS_Muons;</div><div class="line">std::vector&lt;TLorentzVector&gt; MU_KIN_Muons;</div></div><!-- fragment --><p> The only difference to the code snippet to apply systematics is now in the creation of the root node. This now looks like </p><div class="fragment"><div class="line">std::unique_ptr&lt;node_t&gt; root = node_t::createROOT(</div><div class="line">    inputDF, <span class="comment">//&gt; The input to this analysis</span></div><div class="line">    std::make_unique&lt;RDFAnalysis::DefaultBranchNamer&gt;({<span class="stringliteral">&quot;NOSYS&quot;</span>, <span class="stringliteral">&quot;GAM_KIN&quot;</span>, <span class="stringliteral">&quot;ELE_KIN&quot;</span>, <span class="stringliteral">&quot;MU_KIN&quot;</span>}), <span class="comment">//&gt; Now initialised with all the systematic names</span></div><div class="line">    <span class="keyword">false</span> <span class="comment">//&gt; run without weights</span></div><div class="line">    );</div></div><!-- fragment --><p> and the computational graph now generated looks like </p><div class="image">
<img src="example_basic_sel_node_syst.png" alt="example_basic_sel_node_syst.png"/>
</div>
<p> where systematic variations of the same node have been clustered together. Note how each variation is only applied where it is relevant! </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Fri Jun 21 2019 08:10:28 for RDFAnalysis by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.11 </li>
  </ul>
</div>
</body>
</html>
