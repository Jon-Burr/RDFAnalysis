<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>RDFAnalysis: The RDFAnalysis::Node</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">RDFAnalysis
   &#160;<span id="projectnumber">0.1.1</span>
   </div>
   <div id="projectbrief">Physics analysis with ROOT::RDataFrame</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('MD_RDFNode.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">The <a class="el" href="classRDFAnalysis_1_1Node.html" title="Class to represent a single step in the analysis process. ">RDFAnalysis::Node</a> </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><ul>
<li><a href="#Node_Introduction">Introduction</a><ul>
<li><a href="#Node_RNodeDifferences">Differences to ROOT's RNode</a></li>
</ul>
</li>
<li><a href="#Node_Concepts">Node Concepts</a><ul>
<li><a href="#Node_Namer">Branch Namers</a></li>
<li><a href="#Node_Weights">Weights</a></li>
<li><a href="#Node_Detail">Detail</a></li>
<li><a href="#Node_RunMonitors">Run Monitors</a></li>
<li><a href="#Node_OutputWriters">Output Writers</a></li>
</ul>
</li>
<li><a href="#Node_Usage">Usage Example</a></li>
</ul>
<h1><a class="anchor" id="Node_Introduction"></a>
Introduction</h1>
<p>The <a class="el" href="classRDFAnalysis_1_1Node.html">Node</a> class acts as a wrapper around the <a href="https://root.cern/doc/v616/namespaceROOT_1_1RDF.html#a2ddba8d440832e128b144b06b264263f">ROOT::RDF::RNode</a> class. It provides a similar interface for <a class="el" href="classRDFAnalysis_1_1Node.html#a3e7e2e24d9c328a253249ea7e0a8d1a0">Filter</a>, <a class="el" href="classRDFAnalysis_1_1Node.html#ac115944ed7019695d9b89153a3e60304">Define</a> and <a class="el" href="classRDFAnalysis_1_1NodeBase.html#a84b2edf02f47768c1a29ca2f384ff27e">Fill</a>. Most of the other actions are not currently implemented but they can easily be added in.</p>
<p>In order to create the root node of your computational tree you should use the <a class="el" href="classRDFAnalysis_1_1Node.html#afc7c36642cf366bd468f6d285609c57d">createROOT</a> function. All other new nodes will be created by calls to <a class="el" href="classRDFAnalysis_1_1Node.html#a3e7e2e24d9c328a253249ea7e0a8d1a0">Filter</a>.</p>
<h2><a class="anchor" id="Node_RNodeDifferences"></a>
Differences to ROOT's RNode</h2>
<p>From this brief introduction it may sound like there's no reason to use the <a class="el" href="classRDFAnalysis_1_1Node.html" title="Class to represent a single step in the analysis process. ">RDFAnalysis::Node</a> class over the <a href="https://root.cern/doc/v616/namespaceROOT_1_1RDF.html#a2ddba8d440832e128b144b06b264263f">ROOT::RDF::RNode</a> class it wraps. However the new class adds several new concepts omitted from the other. Many of these will be elaborated on in the <a href="#Node_Concepts">Node Concepts</a> section</p>
<ul>
<li><p class="startli">Weights: <a href="https://root.cern/doc/v616/namespaceROOT_1_1RDF.html#a2ddba8d440832e128b144b06b264263f">ROOT::RDF::RNode</a> has no internal concepts of weights being attached to analysis nodes. Weights can be added manually to histogram fill calls, but the default implementation of cutflows cannot be weighted.</p>
<p class="startli">Additionally, it is not easy to deal with event-level weights that change throughout the computational tree, for example due to selections on variables that have associated scale factors.</p>
</li>
<li>Navigation through the computational tree: In the older class it is not possible to navigate from a node to its parent or children in the tree. In the new class this is done using the <a class="el" href="classRDFAnalysis_1_1Node.html#aa94ede088377ff78263755065bbd7a16">parent</a> and <a class="el" href="classRDFAnalysis_1_1Node.html#a4a349ceb26ee7b76ed95301495d90858">children</a> functions.</li>
<li>Storing filled histograms (and other TObjects) natively in the data structure: With the older class the outputs of actions must be stored somewhere external by the user. Here, the results of fill calls are saved onto the Nodes themselves. Similarly, the Detail template allows for storing arbitrary information in the tree data structure.</li>
<li>Systematics: The older class has no native understanding of systematics, whereas this class is built directly around them. The implementation of systematics is necessarily more complicated so it has its <a href="MD_Systematics.html">own dedicated page</a>.</li>
<li>Only <a class="el" href="classRDFAnalysis_1_1Node.html#a3e7e2e24d9c328a253249ea7e0a8d1a0">Filter</a>s create new nodes: For the old class all new transformations (defines and filters) created new nodes which can lead to some confusing outcomes. What actually matters for the tree model of the analysis is that the computational graph splits where multiple different filters must be applied to the same input. There is no gain in allowing a new define call to split the graph.</li>
<li>Define multiple variables in a single call: In the old class it isn't possible to define multiple variables in one call - each variable requires a separate call. This is enabled in this class through the <a class="el" href="classRDFAnalysis_1_1Node.html#a8de0630ec90170a98299b3a43c2456b4">Define overload accepting a std::array</a>.</li>
</ul>
<h1><a class="anchor" id="Node_Concepts"></a>
Node Concepts</h1>
<h2><a class="anchor" id="Node_Namer"></a>
Branch Namers</h2>
<p>Each node has a branch namer object which keeps track of the branches defined at that point in the analysis. This is mainly used for systematic variations (so will be covered on the <a href="MD_Systematics.html">dedicated page</a>) but is also used to work out which variables are used in string expressions.</p>
<h2><a class="anchor" id="Node_Weights"></a>
Weights</h2>
<p>Each <a class="el" href="classRDFAnalysis_1_1Node.html">Node</a> has its own weight, accessed through the <a class="el" href="classRDFAnalysis_1_1NodeBase.html#ada5fe69cecf0f1fc4b53b8a469baeb33">getWeight</a> function. These weights are applied to the weighted cutflow, as well as to any histogram fill calls. Extra arguments can be added to all <a class="el" href="classRDFAnalysis_1_1Node.html#a3e7e2e24d9c328a253249ea7e0a8d1a0">Filter</a> and <a class="el" href="classRDFAnalysis_1_1NodeBase.html#a84b2edf02f47768c1a29ca2f384ff27e">Fill</a> calls to set up changing the weights used in those calls. As with <a class="el" href="classRDFAnalysis_1_1Node.html#ac115944ed7019695d9b89153a3e60304">Define</a> and <a class="el" href="classRDFAnalysis_1_1Node.html#a3e7e2e24d9c328a253249ea7e0a8d1a0">Filter</a> calls, these weights can be calculated either with a C++ function-like object or using a JIT compiled string expression.</p>
<p>Additionally a <a class="el" href="namespaceRDFAnalysis.html#a2af9d406a989f56388185fb5847990bb">WeightStrategy</a> can be specified. This tells the <a class="el" href="classRDFAnalysis_1_1Node.html">Node</a> how it should apply this weight. There are two main options to be configured: whether or not the weight added by this node should be multiplied by the weight of the node before it and whether or not this should weight should be applied always or only in 'MC' mode. MC mode is a setting for the whole computational graph, set in the <a class="el" href="classRDFAnalysis_1_1Node.html#afc7c36642cf366bd468f6d285609c57d">createROOT</a> function, which allows turning off all weights that have the MCOnly WeightStrategy, for example, in order to run on data which does not have those weights. The default value for the WeightStrategy is to be both multiplicative and MC-only.</p>
<h2><a class="anchor" id="Node_Detail"></a>
Detail</h2>
<p>The <a class="el" href="classRDFAnalysis_1_1Node.html">Node</a> class has a 'Detail' template parameter. This is used to add extra information (i.e. not histograms) to be stored within the data structure. This defaults to the <a class="el" href="classRDFAnalysis_1_1EmptyDetail.html">EmptyDetail</a> class which adds no extra information.</p>
<p>An example of extra information that you might want to add is provided by the <a class="el" href="classRDFAnalysis_1_1CutflowDetail.html">CutflowDetail</a> class, which stores information about the number of events passing each filter.</p>
<p>Each node's detail is accessed via the <a class="el" href="classRDFAnalysis_1_1Node.html#acf725f58f319c69f32c92ab37d7c7674">detail</a> function.</p>
<h2><a class="anchor" id="Node_RunMonitors"></a>
Run Monitors</h2>
<p>You can manually trigger the event loop using the <a class="el" href="classRDFAnalysis_1_1Node.html#a2cc948b23e2a54f2c87bef349a9bdf3f">run</a> function. This function can take a template parameter called a Monitor. This object must define an operator() taking a single <code>unsigned int</code> parameter, which is the slot number. This will be provided to the <a href="https://root.cern/doc/v616/classROOT_1_1RDF_1_1RInterface.html#a3650ca30aae1ccd0d92bf3d680314129">ForEachSlot</a> function of the root of the computation graph (only the nominal variation, if systematic variations are present). Alternatively, a print interval and (optional) total number of events can be provided and the default <a class="el" href="classRDFAnalysis_1_1RunMonitor.html" title="The default run monitor. ">RDFAnalysis::RunMonitor</a> will be used.</p>
<p>If you do not want to use this feature, then you can trigger the loop implicitly by trying write out from the result of any of the fill actions.</p>
<h2><a class="anchor" id="Node_OutputWriters"></a>
Output Writers</h2>
<p>In order to write out the information stored in the tree structure you could manually recurse through the tree and write out how you choose. However, the package also provides the <a class="el" href="classRDFAnalysis_1_1OutputWriter.html">OutputWriter</a> class to write out objects for you.</p>
<p>The <a class="el" href="classRDFAnalysis_1_1OutputWriter.html">OutputWriter</a> mirrors the tree structure of the analysis in the output ROOT file with nested directories representing each step in the computation. The output to be written from each node is decided by adding <a class="el" href="classRDFAnalysis_1_1INodeWriter.html">INodeWriter</a>s to the <a class="el" href="classRDFAnalysis_1_1OutputWriter.html">OutputWriter</a>. These decide what information to write from each node and how.</p>
<p>Two of these are pre-written. The <a class="el" href="classRDFAnalysis_1_1TObjectWriter.html">TObjectWriter</a> writes the output of all <a class="el" href="classRDFAnalysis_1_1NodeBase.html#a84b2edf02f47768c1a29ca2f384ff27e">Fill</a> actions. The <a class="el" href="classRDFAnalysis_1_1CutflowWriter.html">CutflowWriter</a> converts the information stored in the <a class="el" href="classRDFAnalysis_1_1CutflowDetail.html">CutflowDetail</a> into a cutflow, therefore in order to use this class the Detail type of the node must at least inherit from <a class="el" href="classRDFAnalysis_1_1CutflowDetail.html">CutflowDetail</a>.</p>
<h1><a class="anchor" id="Node_Usage"></a>
Usage Example</h1>
<p>Returning to Z&gamma; example used earlier, assuming that the input TTree contains three branches </p><div class="fragment"><div class="line">std::vector&lt;TLorentzVector&gt; Photons;</div><div class="line">std::vector&lt;TLorentzVector&gt; Electrons;</div><div class="line">std::vector&lt;TLorentzVector&gt; Muons;</div></div><!-- fragment --><p> containing the kinematics of all photons, electrons and muons passing certain object-level selections, then the corresponding code snippet to create the computational graph and write out the histograms would be (assuming an input ROOT::RDataFrame object called inputDF): </p><div class="fragment"><div class="line"><span class="keyword">using</span> node_t = <a class="code" href="classRDFAnalysis_1_1Node.html">RDFAnalysis::Node&lt;CutflowDetail&gt;</a>;</div><div class="line"></div><div class="line">std::unique_ptr&lt;node_t&gt; root = node_t::createROOT(</div><div class="line">    inputDF, <span class="comment">//&gt; The input to this analysis</span></div><div class="line">    std::make_unique&lt;RDFAnalysis::DefaultBranchNamer&gt;({<span class="stringliteral">&quot;NOSYS&quot;</span>}), <span class="comment">//&gt; Systematics related</span></div><div class="line">    <span class="keyword">false</span> <span class="comment">//&gt; run without weights</span></div><div class="line">    );</div><div class="line"></div><div class="line">node_t* photonSelection = root-&gt;Filter(<span class="stringliteral">&quot;Photons.size() == 1&quot;</span>, <span class="stringliteral">&quot;N_GAM_1&quot;</span>, <span class="stringliteral">&quot;Exactly one photon&quot;</span>);</div><div class="line">photonSelection-&gt;</div><div class="line">  Filter(<span class="stringliteral">&quot;Electrons.size() == 2&quot;</span>, <span class="stringliteral">&quot;N_ELE_2&quot;</span>, <span class="stringliteral">&quot;Exactly two electrons&quot;</span>)-&gt;</div><div class="line">  Define(<span class="stringliteral">&quot;m_ee&quot;</span>, <span class="stringliteral">&quot;(Electrons.at(0) + Electrons.at(1)).M() )&quot;</span>)-&gt;</div><div class="line">  Fill(TH1F(<span class="stringliteral">&quot;m_ee&quot;</span>, <span class="stringliteral">&quot;;m_{ee} [GeV]&quot;</span>, 50, 50, 100), {<span class="stringliteral">&quot;m_ee&quot;</span>});</div><div class="line">photonSelection-&gt;</div><div class="line">  Filter(<span class="stringliteral">&quot;Muons.size() == 2&quot;</span>, <span class="stringliteral">&quot;N_MU_2&quot;</span>, <span class="stringliteral">&quot;Exactly two muons&quot;</span>)-&gt;</div><div class="line">  Define(<span class="stringliteral">&quot;m_mumu&quot;</span>, <span class="stringliteral">&quot;(Muons.at(0) + Muons.at(1)).M() )&quot;</span>)-&gt;</div><div class="line">  Fill(TH1F(<span class="stringliteral">&quot;m_mumu&quot;</span>, <span class="stringliteral">&quot;;m_{#mu#mu} [GeV]&quot;</span>, 50, 50, 100), {<span class="stringliteral">&quot;m_mumu&quot;</span>});</div><div class="line"></div><div class="line"><a class="code" href="classRDFAnalysis_1_1OutputWriter.html">RDFAnalysis::OutputWriter&lt;node_t::detail_t&gt;</a> writer(<span class="stringliteral">&quot;output.root&quot;</span>);</div><div class="line">writer.addWriter&lt;<a class="code" href="classRDFAnalysis_1_1CutflowWriter.html">RDFAnalysis::CutflowWriter</a>&gt;();</div><div class="line">writer.addWriter&lt;<a class="code" href="classRDFAnalysis_1_1TObjectWriter.html">RDFAnalysis::TObjectWriter</a>&gt;();</div><div class="line">writer.<a class="code" href="classRDFAnalysis_1_1TObjectWriter.html#a44e8c142f6cf561f83af21872808a01a">write</a>(*root);</div></div><!-- fragment --><p>This will produce a computation graph that looks like</p>
<div class="image">
<img src="example_basic_sel_node.png" alt="example_basic_sel_node.png"/>
</div>
 </div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Fri Jun 21 2019 08:10:28 for RDFAnalysis by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.11 </li>
  </ul>
</div>
</body>
</html>
